AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: AWS resources for MedFoyer backend
Parameters: 
        EnvType: 
                Description: Environment type.
                Default: sandbox
                Type: String
                AllowedValues: 
                        - prod
                        - dev
                        - sandbox
                ConstraintDescription: must specify valid stage [prod|dev|sandbox].

Globals:
        Function:
                Environment:
                        Variables:
                                STAGE: !Sub "${EnvType}"

Mappings:
        AppSync:
                RequestMappings:
                        LambdaAddClinic: |
                                #set($unused = $context.args.put("clinic_id", $context.identity.claims.clinic_id))
                                â€‹
                                {
                                  "version" : "2017-02-28",
                                  "operation": "Invoke",
                                  "payload": $util.toJson($context.args)
                                }
                        DynamoScopedClinicPut: |
                                #set($patient = $ctx.args.patient.put("clinic_id", $ctx.identity.claims.clinic_id))

                                {
                                    "version" : "2017-02-28",
                                    "operation" : "PutItem",
                                    "key" : {
                                        ## If object "id" should come from GraphQL arguments, change to $util.dynamodb.toDynamoDBJson($ctx.args.id)
                                        "patient_id": $util.dynamodb.toDynamoDBJson($util.autoId()),
                                    },
                                    "attributeValues" : $util.dynamodb.toMapValuesJson($ctx.args.patient)
                                }
                        DynamoScopedClinicDelete: |
                                #set($clinic_id = $ctx.identity.claims.clinic_id)

                                {
                                    "version" : "2017-02-28",
                                    "operation" : "DeleteItem",
                                    "key" : {
                                        ## If your table's hash key is not named 'id', update it here. **
                                        "appointment_id" : { "S" : "${ctx.args.appointment_id}" }
                                        ## If your table has a sort key, add it as an item here. **
                                    },
                                    "condition" : {
                                        "expression" : "clinic_id = :clinic_id",
                                        "expressionValues" : {":clinic_id" : $util.dynamodb.toDynamoDBJson($clinic_id)}
                                    }
                                }

                ResponseMappings:
                        LambdaGeneric: |
                                $util.toJson($context.result)
                        DynamoScopedClinicGet: |
                                #set( $clinic_id = $context.identity.claims.clinic_id )
                                #if($context.result["clinic_id"] == "$clinic_id")
                                    $util.toJson($ctx.result)
                                #end


Resources:
        GraphApi:
                Type: AWS::AppSync::GraphQLApi
                Properties:
                        AuthenticationType: AMAZON_COGNITO_USER_POOLS
                        Name: !Sub "${EnvType} GraphQL API"
                        UserPoolConfig:
                                AppIdClientRegex: 2ltoku7mtgrcr7av6b4f78iue3
                                AwsRegion: us-west-2
                                DefaultAction: DENY
                                UserPoolId: us-west-2_QH96yFFpV
        PatientApi:
                Type: AWS::Serverless::Api
                Properties:
                        StageName: !Ref EnvType
                        Cors:
                                AllowMethods: "'POST, GET, OPTIONS'"
                                AllowHeaders: "'X-Forwarded-For,X-Auth-Token,Content-Type,Accept'"
                                AllowOrigin: "'*'"
                                AllowCredentials: False
        GetAppointment:
                Type: AWS::Serverless::Function
                Properties:
                        FunctionName: !Sub "${EnvType}-get-appointment"
                        Handler: handlers/appointment.handler
                        Runtime: python3.8
                        CodeUri: ./
        CheckInAppointment:
                Type: AWS::Serverless::Function
                Properties:
                        FunctionName: !Sub "${EnvType}-check-in-appointment"
                        Policies:
                                - AmazonDynamoDBFullAccess
                                - AmazonSSMReadOnlyAccess
                        Handler: handlers/appointment.check_in_handler
                        Runtime: python3.8
                        CodeUri: ./
                        Events:
                                CheckInAppointmentApi:
                                        Type: Api
                                        Properties:
                                                RestApiId: !Ref PatientApi
                                                Path: /CheckInAppointment
                                                Method: POST
        SubmitAppointmentForm:
                Type: AWS::Serverless::Function
                Properties:
                        FunctionName: !Sub "${EnvType}-submit-appointment-form"
                        Policies:
                                - AmazonDynamoDBFullAccess
                                - AmazonS3FullAccess
                                - AmazonSSMReadOnlyAccess
                        Handler: handlers/appointment.submit_form_handler
                        Runtime: python3.8
                        CodeUri: ./
                        Events:
                                SubmitAppointmentApi:
                                        Type: Api
                                        Properties:
                                                RestApiId: !Ref PatientApi
                                                Path: /SubmitAppointmentForm
                                                Method: POST
        GetForms:
                Type: AWS::Serverless::Function
                Properties:
                        FunctionName: !Sub "${EnvType}-get-forms"
                        Policies:
                                - AmazonS3FullAccess
                        Handler: handlers/appointment.get_forms_handler
                        Runtime: python3.8
                        CodeUri: ./
        SummonPatient:
                Type: AWS::Serverless::Function
                Properties:
                        FunctionName: !Sub "${EnvType}-summon-patient-appointment"
                        Policies:
                                - AmazonDynamoDBFullAccess
                                - AmazonSSMReadOnlyAccess
                        Handler: handlers/appointment.summon_patient_handler
                        Runtime: python3.8
                        CodeUri: ./
                        Timeout: 10
        GetWaitlistPriority:
                Type: AWS::Serverless::Function
                Properties:
                        FunctionName: !Sub "${EnvType}-get-waitlist-position"
                        Policies:
                                - AmazonDynamoDBFullAccess
                                - AmazonSSMReadOnlyAccess
                        Handler: handlers/appointment.get_waitlist_position_handler
                        Runtime: python3.8
                        CodeUri: ./
                        Events:
                                GetWaitlistPriorityApi:
                                        Type: Api
                                        Properties:
                                                RestApiId: !Ref PatientApi
                                                Path: /Waitlist
                                                Method: GET
        AddUserClaims:
                Type: AWS::Serverless::Function
                Properties:
                        FunctionName: !Sub "${EnvType}-add-user-claims"
                        Handler: handlers/auth.claim_add_handler
                        Runtime: python3.8
                        CodeUri: ./
        SendAppointmentReminders:
                Type: AWS::Serverless::Function
                Properties:
                        FunctionName: !Sub "${EnvType}-send-appointment-reminders"
                        Policies:
                                - AmazonDynamoDBFullAccess
                                - AmazonSSMReadOnlyAccess
                        Handler: handlers/appointment.send_appointment_reminders_handler
                        Runtime: python3.8
                        CodeUri: ./
                        Timeout: 50
                        Events:
                                SARSchedule:
                                        Type: Schedule
                                        Properties:
                                                Schedule: 'rate(1 minute)'
                                                Name: !Sub "${EnvType}-send-appointment-reminders-schedule"
                                                Description: Schedule to send needed text messages
                                                Enabled: True
        SendCheckInText:
                Type: AWS::Serverless::Function
                Properties:
                        FunctionName: !Sub "${EnvType}-send-check-in-text"
                        Policies:
                                - AmazonDynamoDBFullAccess
                                - AmazonSSMReadOnlyAccess
                        Handler: handlers/appointment.send_check_in_text_handler
                        Runtime: python3.8
                        CodeUri: ./
                        Timeout: 10
        AuthAppointment:
                Type: AWS::Serverless::Function
                Properties:
                        FunctionName: !Sub "${EnvType}-auth-appointment-handler"
                        Policies:
                                - AmazonDynamoDBFullAccess
                                - AmazonSSMReadOnlyAccess
                        Handler: handlers/auth.auth_appointment_handler
                        Runtime: python3.8
                        CodeUri: ./
                        Events:
                                AuthAppointmentApi:
                                        Type: Api
                                        Properties:
                                                RestApiId: !Ref PatientApi
                                                Path: /AuthAppointment
                                                Method: POST
        GetClinicLatLong:
                Type: AWS::Serverless::Function
                Properties:
                        FunctionName: !Sub "${EnvType}-get-clinic-lat-long-handler"
                        Policies:
                                - AmazonDynamoDBFullAccess
                                - AmazonSSMReadOnlyAccess
                        Handler: handlers/appointment.get_clinic_lat_long_handler
                        Runtime: python3.8
                        CodeUri: ./
                        Events:
                                GetClinicLatLongApi:
                                        Type: Api
                                        Properties:
                                                RestApiId: !Ref PatientApi
                                                Path: /ClinicLocation
                                                Method: GET

#        SummonPatientDataSource:
#                Type: AWS::AppSync::DataSource
#                Properties:
#                        ApiId: !Ref GraphApi
#                        LambdaConfig:
#                        Name: summon_patient_lambda
#                        ServiceRoleArn: String
#                        Type: String


        GraphSchema:
                Type: AWS::AppSync::GraphQLSchema
                Properties:
                        ApiId: !Ref GraphApi
                        Definition: |
                                type Appointment @aws_cognito_user_pools(cognito_groups: ["practitioners"]) {
                                	appointment_id: ID!
                                	status: String!
                                	covid_flag: String
                                	appointment_time: AWSTimestamp!
                                	forms: [String]
                                	clinic_location_id: ID!
                                	clinic_location: ClinicLocation
                                	patient: Patient
                                	doctor_id: ID!
                                	reminder_status: ReminderStatus
                                	check_in_latitude: Float
                                	check_in_longitude: Float
                                	check_in_time: AWSTimestamp
                                }

                                input AppointmentInput {
                                	status: AppointmentStatus
                                	covid_flag: String
                                	appointment_time: AWSTimestamp!
                                	forms: [String]
                                	clinic_location_id: ID!
                                	patient_id: ID!
                                	doctor_id: ID!
                                	reminder_status: ReminderStatus
                                }

                                enum AppointmentStatus {
                                	SCHEDULED
                                	FILLING_FORMS
                                	CHECKED_IN
                                	SUMMONED
                                }

                                type Clinic @aws_cognito_user_pools(cognito_groups: ["practitioners"]) {
                                	clinic_id: ID!
                                	clinic_name: String!
                                	clinic_locations: [ClinicLocation]
                                }

                                input ClinicInput {
                                	clinic_name: String!
                                }

                                type ClinicLocation @aws_cognito_user_pools(cognito_groups: ["practitioners"]) {
                                	clinic_location_name: String!
                                	clinic_location_id: ID!
                                	latitude: String!
                                	longitude: String!
                                	city: String!
                                	#Potentially eventually an Enum
                                	state: String!
                                	zip: String!
                                	address: String!
                                	required_forms: [ID]
                                }

                                input ClinicLocationInput {
                                	clinic_location_name: String!
                                	latitude: String!
                                	longitude: String!
                                	city: String!
                                	state: String!
                                	address: String!
                                	zip: String!
                                	required_forms: [ID]
                                }

                                type Mutation @aws_cognito_user_pools(cognito_groups: ["practitioners"]) {
                                	#Patient
                                	checkIn(appointment_id: ID!, latitude: String!, longitude: String!): Appointment
                                	submitAppointmentForm(appointment_id: ID!, form: String!): Appointment
                                	#Clinic
                                	createAppointment(
                                		status: String!,
                                		appointment_time: AWSTimestamp!,
                                		patient_id: ID!,
                                		clinic_location_id: ID!,
                                		doctor_id: ID!,
                                		reminder_status: ReminderStatus
                                	): Appointment
                                	deleteAppointment(appointment_id: ID!): Appointment
                                	updateAppointment(appointment_id: ID!, appointment: AppointmentInput): Appointment
                                	sendCheckInText(appointment_id: ID!): Boolean
                                	summonPatient(appointment_id: ID!): Appointment
                                	createPatient(patient: PatientInput): Patient
                                	#Admin, for future use
                                	createUser(name: String): User
                                	createClinicLocation(clinic_location: ClinicLocationInput): ClinicLocation
                                		@aws_cognito_user_pools(cognito_groups: ["practitioners"])
                                	#Assuming not a hard delete for auditing reasons
                                	deleteUser(user_id: String!): User
                                	grantPermission(user_id: String!, permission: PermissionInput): User
                                	#medfoyer admins
                                	createClinic(clinic: ClinicInput): Clinic
                                		@aws_cognito_user_pools(cognito_groups: ["medfoyer-admins"])
                                }

                                type Patient @aws_cognito_user_pools(cognito_groups: ["practitioners"]) {
                                	patient_id: ID!
                                	birth_date: AWSDate
                                	given_name: String
                                	last_name: String
                                	appointment_ids: String
                                	appointments: [Appointment]
                                	phone_number: AWSPhone
                                	phone_number_country_code: Int
                                }

                                type PatientAppointment {
                                	appointment_time: Int
                                }

                                input PatientInput {
                                	birth_date: AWSDate!
                                	given_name: String!
                                	last_name: String!
                                	phone_number: AWSPhone
                                	phone_number_country_code: Int!
                                }

                                input PermissionInput {
                                	role: String!
                                	scope: String!
                                }

                                type Query @aws_cognito_user_pools(cognito_groups: ["practitioners"]) {
                                	#patient
                                	getWaitlistPosition(appointment_id: ID!): WaitlistPosition
                                	##Clinic, scoped to a clinic unless otherwise noted
                                	getAppointment(appointment_id: ID!): Appointment
                                	listAppointments: [Appointment]
                                	getPatient(patient_id: ID!): Patient
                                	listPatients: [Patient]
                                	getClinic: Clinic
                                	#internal
                                	getContext: String
                                	getClinicLocations: [ClinicLocation]
                                }

                                enum ReminderStatus {
                                	NONE_SENT
                                	FIRST_REMINDER_SENT
                                	CHECK_IN_REMINDER_SENT
                                	OPT_OUT
                                }

                                type User {
                                	user_id: ID!
                                }

                                type WaitlistPosition {
                                	position: Int
                                	expected_wait_time: Int
                                }

                                schema {
                                	query: Query
                                	mutation: Mutation
                                }
